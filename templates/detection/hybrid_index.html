{% extends "base.html" %}

{% block title %}Hybrid Pipeline - MelaScan{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
  <header class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white shadow-lg">
    <div class="container mx-auto px-6 py-4">
      <div class="flex items-center justify-between">
        <h1 class="text-2xl font-bold">Hybrid Melasma Pipeline</h1>
        <a href="{% url 'dashboard' %}" class="bg-white text-purple-600 px-4 py-2 rounded-lg font-semibold hover:bg-gray-100 transition">Dashboard</a>
      </div>
    </div>
  </header>

  <div class="container mx-auto px-6 py-6">
    {% if messages %}
      {% for message in messages %}
        <div class="mb-4 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-700{% elif message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Segmentation Tab -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold mb-2">Segmentation</h2>
        <p class="text-sm text-gray-600 mb-4">Best model: {{ best_seg.name|default:"N/A" }}</p>

        <form method="post" enctype="multipart/form-data" action="{% url 'hybrid_run_segmentation' %}" class="space-y-4">
          {% csrf_token %}
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image</label>
            <input type="file" name="image" accept="image/*" required />
          </div>
          <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">Run Segmentation</button>
        </form>

        {% if uploaded_image_url %}
          <div class="mt-6 grid grid-cols-2 gap-4 items-start">
            <div>
              <h3 class="font-semibold mb-2">Original</h3>
              <img src="{{ uploaded_image_url }}" class="rounded border" />
            </div>
            <div>
              <h3 class="font-semibold mb-2">Mask Overlay</h3>
              <img src="{{ overlay_url }}" class="rounded border" />
            </div>
          </div>
        {% endif %}
      </div>

      <!-- Classification Tab -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-bold mb-2">Classification</h2>
        <p class="text-sm text-gray-600 mb-4">Best model: {{ best_cls.name|default:"N/A" }}</p>

        <form method="post" enctype="multipart/form-data" action="{% url 'hybrid_run_classification' %}" class="space-y-4">
          {% csrf_token %}
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image (or segmented image)</label>
            <input type="file" name="image" accept="image/*" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Or Upload Segmented Result (optional)</label>
            <input type="file" name="segmented" accept="image/*" />
          </div>
          <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">Run Classification</button>
        </form>

        {% if classification_label %}
          <div class="mt-6">
            <h3 class="font-semibold mb-2">Result</h3>
            <p class="text-gray-800">Prediction: <span class="font-bold">{{ classification_label }}</span></p>
            {% if non_melasma_type %}
              <p class="text-gray-600">Subtype: {{ non_melasma_type }}</p>
            {% endif %}
            {% if classification_probs %}
              <p class="text-gray-600 text-sm mt-2">Probs: {{ classification_probs }}</p>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}


